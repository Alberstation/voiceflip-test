services:
  # Creates document/OpenClaw dirs on host before other services need them (run once per up)
  init-dirs:
    image: alpine:3.19
    volumes:
      - .:/workspace
    working_dir: /workspace
    command: sh -c "mkdir -p .openclaw-config .openclaw-workspace docs && echo Directories ready"
    restart: "no"

  app:
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "8000:8000"
    environment:
      - QDRANT_HOST=vectordb
      - QDRANT_PORT=6333
      # Phase 2: from .env (Compose loads project .env for substitution)
      - HUGGINGFACEHUB_API_TOKEN=${HUGGINGFACEHUB_API_TOKEN:-}
      # Phase 6: optional OpenClaw proxy (frontend "Send to OpenClaw")
      - OPENCLAW_GATEWAY_URL=${OPENCLAW_GATEWAY_URL:-}
      - OPENCLAW_GATEWAY_TOKEN=${OPENCLAW_GATEWAY_TOKEN:-}
    depends_on:
      vectordb:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 5s

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    ports:
      - "5173:5173"
    environment:
      - VITE_API_URL=http://localhost:8000
    depends_on:
      app:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://127.0.0.1:5173/"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s

  vectordb:
    image: qdrant/qdrant:latest
    depends_on:
      init-dirs:
        condition: service_completed_successfully
    ports:
      - "6333:6333"
      - "6334:6334"
    volumes:
      - qdrant_storage:/qdrant/storage
    healthcheck:
      # Qdrant image has no curl; use TCP port check
      test: ["CMD-SHELL", "bash -c ':> /dev/tcp/127.0.0.1/6333' || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s

  # OpenClaw (Phase 6) — starts with main stack; use for research → generate doc → upload to RAG
  openclaw-gateway:
    image: alpine/openclaw:main
    environment:
      HOME: /home/node
      TERM: xterm-256color
      OPENCLAW_GATEWAY_TOKEN: ${OPENCLAW_GATEWAY_TOKEN:-}
      RAG_API_URL: http://app:8000
    volumes:
      - ${OPENCLAW_CONFIG_DIR:-./.openclaw-config}:/home/node/.openclaw
      - ${OPENCLAW_WORKSPACE_DIR:-./.openclaw-workspace}:/home/node/.openclaw/workspace
      - ./openclaw-skill-rag:/home/node/.openclaw/workspace/skills/rag-query:ro
    ports:
      - "${OPENCLAW_GATEWAY_PORT:-18789}:18789"
      - "${OPENCLAW_BRIDGE_PORT:-18790}:18790"
    networks:
      - default
    depends_on:
      init-dirs:
        condition: service_completed_successfully
      app:
        condition: service_healthy
    init: true
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "node dist/index.js health --token \"$$OPENCLAW_GATEWAY_TOKEN\" || exit 1"]
      interval: 15s
      timeout: 10s
      retries: 3
      start_period: 20s
    command:
      - node
      - dist/index.js
      - gateway
      - --allow-unconfigured
      - --bind
      - "lan"
      - --port
      - "18789"

  # One-off CLI for first-time onboarding: docker compose run --rm openclaw-cli onboard
  openclaw-cli:
    image: alpine/openclaw:main
    environment:
      HOME: /home/node
      TERM: xterm-256color
      OPENCLAW_GATEWAY_TOKEN: ${OPENCLAW_GATEWAY_TOKEN:-}
      BROWSER: echo
      RAG_API_URL: http://app:8000
    volumes:
      - ${OPENCLAW_CONFIG_DIR:-./.openclaw-config}:/home/node/.openclaw
      - ${OPENCLAW_WORKSPACE_DIR:-./.openclaw-workspace}:/home/node/.openclaw/workspace
      - ./openclaw-skill-rag:/home/node/.openclaw/workspace/skills/rag-query:ro
    networks:
      - default
    stdin_open: true
    tty: true
    init: true
    entrypoint: ["node", "dist/index.js"]
    profiles:
      - tools

networks:
  default:
    name: voiceflip-net

volumes:
  qdrant_storage:
    driver: local
